<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Talk - è§’è‰²è¯­éŸ³å¯¹è¯</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: #10182a;
        --panel-2: #0e1526;
        --text: #e6ecff;
        --muted: #94a3b8;
        --brand: #ff7eb6;
        --brand-2: #7df9ff;
        --card: #0f172a;
        --border: #1e293b;
        --user: #1f2d4a;
        --bot: #141f35;
      }
      body[data-theme="light"] {
        --bg: #fff9f5;
        --panel: #ffffff;
        --panel-2: #fff0e6;
        --text: #0b1020;
        --muted: #667085;
        --brand: #ff9e43;
        --brand-2: #ffd470;
        --card: #ffffff;
        --border: #ffcc80;
        --user: #fff3e0;
        --bot: #fff8e1;
      }
      
      /* æµ…è‰²ä¸»é¢˜ä¸‹å¯¹æ–¹æ°”æ³¡æ ·å¼ä¼˜åŒ– */
      body[data-theme="light"] .bubble.bot {
        background: linear-gradient(180deg, #fff8e1, #fff3e0);
        border: 1px solid #ffcc80;
      }
      
      /* æµ…è‰²ä¸»é¢˜ä¸‹å¤´åƒæ ·å¼ä¼˜åŒ– */
      body[data-theme="light"] .avatar {
        box-shadow: 0 2px 8px rgba(0,0,0,.15);
      }
      
      body[data-theme="light"] .avatar.bot {
        background: linear-gradient(135deg, #ff9e43, #ffd470);
        color: white;
        font-size: 14px;
        font-weight: 800;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: radial-gradient(1200px 600px at 20% -10%, rgba(255,126,182,.25), transparent 50%),
                    radial-gradient(900px 500px at 100% 0%, rgba(125,249,255,.18), transparent 50%),
                    var(--bg);
      }
      body[data-theme="light"] {
        background: radial-gradient(1200px 600px at 20% -10%, rgba(255,158,67,.15), transparent 50%),
                    radial-gradient(900px 500px at 100% 0%, rgba(255,212,112,.10), transparent 50%),
                    var(--bg);
      }
      .shell { max-width: 1200px; margin: 0 auto; padding: 16px; height: 100vh; display: flex; flex-direction: column; }
      .nav { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border: 1px solid var(--border); border-radius: 16px; padding: 12px 20px; backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06); margin-bottom: 16px; }
      .brand { display: flex; gap: 12px; align-items: center; font-weight: 700; letter-spacing: .2px; font-size: 20px; }
      .logo { width: 32px; height: 32px; border-radius: 10px; background: linear-gradient(135deg, var(--brand), var(--brand-2)); box-shadow: 0 4px 16px rgba(255,158,67,.5); }
      .actions { display: flex; gap: 12px; align-items: center; }
      .btn { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); color: var(--text); background: var(--panel-2); cursor: pointer; transition: .2s ease; box-shadow: inset 0 1px 0 rgba(255,255,255,.05); }
      .btn:hover { transform: translateY(-1px); border-color: #314159; }
      .btn.primary { background: linear-gradient(135deg, var(--brand), #ffd470); border-color: transparent; box-shadow: 0 8px 20px rgba(255,158,67,.35); }
      .btn.ghost { background: transparent; }
      .main-container { display: flex; flex: 1; gap: 16px; overflow: hidden; }
      .side-panel { width: 360px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid var(--border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; transition: transform 0.3s ease; position: relative; z-index: 10; }
      .chat-panel { flex: 1; display: flex; flex-direction: column; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
      .mobile-toggle { display: none; position: fixed; bottom: 20px; left: 20px; z-index: 20; background: var(--brand); color: white; border: none; width: 56px; height: 56px; border-radius: 50%; box-shadow: 0 4px 16px rgba(255,158,67,.5); font-size: 20px; }
      
      @media (max-width: 920px) {
        .side-panel {
          position: fixed;
          left: -360px;
          top: 0;
          height: 100vh;
          z-index: 100;
        }
        .side-panel.open {
          transform: translateX(360px);
        }
        .mobile-toggle {
          display: block;
        }
      }
      .search { display: flex; gap: 10px; margin-bottom: 16px; }
      .input { flex: 1; background: var(--panel-2); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; outline: none; font-size: 14px; }
      .roles { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; margin-top: 12px; flex: 1; }
      .roles::-webkit-scrollbar {
        width: 6px;
      }
      .card { border: 1px solid var(--border); background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.25); transition: transform .2s ease, box-shadow .2s ease; cursor: pointer; }
      .card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,.35); }
      .card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,.35); }
      .tagline { color: var(--muted); font-size: 12px; margin: 6px 0 10px; line-height: 1.4; }
      .chat-header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.02), transparent); }
      .chat { flex: 1; overflow: auto; padding: 20px; background: var(--panel); }
      .chat::-webkit-scrollbar {
        width: 8px;
      }
      .message-row { display: flex; align-items: flex-start; margin: 8px 0; }
      .message-row.user { justify-content: flex-end; }
      .message-row.bot { justify-content: flex-start; }
      .avatar { width: 32px; height: 32px; border-radius: 50%; margin: 0 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
      .avatar.user { background: linear-gradient(135deg, #ff9b9b, #ffd166); }
      .avatar.bot { background: linear-gradient(135deg, #7df9ff, #4cc9f0); }
      .bubble { max-width: 70%; padding: 10px 12px; border-radius: 14px; line-height: 1.55; box-shadow: 0 6px 16px rgba(0,0,0,.25); }
      .bubble.user { background: linear-gradient(180deg, rgba(255,155,155,.18), rgba(255,155,155,.08)); border: 1px solid #ff9b9b; margin-left: auto; }
      .bubble.bot { background: linear-gradient(180deg, rgba(125,249,255,.18), rgba(125,249,255,.08)); border: 1px solid #7df9ff; }
      .assist { color: var(--muted); font-size: 12px; margin-top: 6px; }
      .composer-container { padding: 20px; border-top: 1px solid var(--border); background: linear-gradient(0deg, rgba(255,255,255,.02), transparent); }
      .composer { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: flex-end; margin-bottom: 12px; }
      textarea { width: 100%; height: 80px; resize: vertical; background: var(--panel-2); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; outline: none; font-size: 14px; transition: border-color 0.2s ease; }
      textarea:focus { border-color: var(--brand); }
      .status { color: var(--muted); font-size: 12px; text-align: center; }
      ::-webkit-scrollbar { width: 10px; height: 10px; }
      ::-webkit-scrollbar-thumb { background: #ff9e43; border-radius: 10px; }
      ::-webkit-scrollbar-track { background: transparent; }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="nav">
        <div style="flex: 1;"></div>
        <div class="brand"><div class="logo"></div>AI Talk Â· è§’è‰²è¯­éŸ³å¯¹è¯</div>
        <div style="flex: 1; display: flex; justify-content: flex-end;">
          <div class="actions">
            <button class="btn ghost" id="themeBtn">ğŸŒ™ æš—è‰²</button>
          </div>
        </div>
      </div>

      <div class="main-container">
        <div id="side-panel" class="side-panel">
          <div class="search">
            <input id="search" class="input" placeholder="æ‰¾ä¸åˆ°ï¼Ÿæœä¸€æœ" />
            <button id="searchBtn" class="btn">æœç´¢</button>
            <button id="refreshBtn" class="btn ghost">å…¨éƒ¨</button>
          </div>
          <div id="roles" class="roles"></div>
        </div>

        <div class="chat-panel">
          <div class="chat-header">
            <div class="assist">å½“å‰è§’è‰²ï¼š<span id="currentRole">(æœªé€‰æ‹©)</span></div>
          </div>
          <div class="chat" id="chat"></div>
          <div class="composer-container">
            <div class="composer">
              <textarea id="text" placeholder="è¾“å…¥æˆ–ç”¨è¯­éŸ³è¯´è¯â€¦"></textarea>
              <button id="micBtn" class="btn">ğŸ¤ å½•éŸ³</button>
              <button id="sendBtn" class="btn primary">å‘é€</button>
            </div>
            <div class="status" id="status">å‡†å¤‡å°±ç»ª</div>
          </div>
        </div>
      </div>

      <button id="mobile-toggle" class="mobile-toggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" x2="21" y1="12" y2="12"></line>
          <line x1="3" x2="21" y1="6" y2="6"></line>
          <line x1="3" x2="21" y1="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <script>
      const api = (path, options={}) => fetch(path, options).then(r => r.json());
      const chatDiv = document.getElementById('chat');
      let roleId = null;
      let messages = [];
      let mediaStream = null; let mediaRecorder = null; let chunks = [];

      function append(role, text) {
        // åˆ›å»ºæ¶ˆæ¯è¡Œå®¹å™¨
        const messageRow = document.createElement('div');
        messageRow.className = `message-row ${role}`;
        
        // åˆ›å»ºå¤´åƒ
        const avatar = document.createElement('div');
        avatar.className = `avatar ${role}`;
        // ä½¿ç”¨ç®€å•çš„å›¾æ ‡è¡¨ç¤ºä¸åŒè§’è‰²
        avatar.textContent = role === 'user' ? 'æˆ‘' : 'AI';
        
        // åˆ›å»ºæ°”æ³¡
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role === 'user' ? 'user' : 'bot'}`;
        bubble.textContent = text;
        
        // æ ¹æ®è§’è‰²æ”¾ç½®å¤´åƒå’Œæ°”æ³¡
        if (role === 'user') {
          messageRow.appendChild(bubble);
          messageRow.appendChild(avatar);
        } else {
          messageRow.appendChild(avatar);
          messageRow.appendChild(bubble);
        }
        
        chatDiv.appendChild(messageRow);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }

      async function loadRoles(q='') {
        const list = await api(`/api/roles${q ? ('?q=' + encodeURIComponent(q)) : ''}`);
        const box = document.getElementById('roles');
        box.innerHTML = '';
        list.forEach(r => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <div>
                <div style="font-weight:700;">${r.name}</div>
                <div class="tagline">${r.skills.join(' / ')}</div>
              </div>
              <button class="btn" data-id="${r.id}">é€‰æ‹©</button>
            </div>
          `;
          card.querySelector('button').onclick = () => { roleId = r.id; document.getElementById('currentRole').textContent = r.name; messages = []; chatDiv.innerHTML = ''; speak(''); };
          box.appendChild(card);
        });
      }

      async function sendText(text) {
        if (!roleId) { alert('è¯·å…ˆé€‰æ‹©è§’è‰²'); return; }
        append('user', text);
        messages.push({ role: 'user', content: text });
        document.getElementById('status').textContent = 'æ€è€ƒä¸­â€¦';
        const resp = await api('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ roleId, messages }) });
        const bot = resp.text || '(æ— å›å¤)';
        messages.push({ role: 'assistant', content: bot });
        append('assistant', bot);
        speak(bot);
        document.getElementById('status').textContent = 'å®Œæˆ';
      }

      // Web Speech API TTSï¼ˆæµè§ˆå™¨å†…ç½®ï¼Œä½œä¸ºæ¼”ç¤ºï¼›ç”Ÿäº§å¯æ›¿æ¢äº‘ç«¯TTSï¼‰
      function speak(text) {
        try {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'zh-CN';
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        } catch (e) {}
      }

      // è½»é‡ASRæ¼”ç¤ºï¼šä½¿ç”¨æµè§ˆå™¨SpeechRecognitionï¼ˆéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰
      let rec = null; let recognizing = false;
      function toggleMic() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œå»ºè®®ä½¿ç”¨Chrome'); return; }
        if (!rec) {
          rec = new SR(); rec.lang = 'zh-CN'; rec.interimResults = false; rec.maxAlternatives = 1;
          rec.onresult = e => { const t = e.results[0][0].transcript; document.getElementById('text').value = t; document.getElementById('status').textContent = 'è¯†åˆ«å®Œæˆ'; };
          rec.onend = () => { recognizing = false; document.getElementById('micBtn').textContent = 'ğŸ¤ å¼€å§‹å½•éŸ³'; };
          rec.onerror = () => { recognizing = false; document.getElementById('status').textContent = 'è¯†åˆ«å‡ºé”™'; };
        }
        if (!recognizing) { rec.start(); recognizing = true; document.getElementById('micBtn').textContent = 'â–  åœæ­¢'; document.getElementById('status').textContent = 'æ­£åœ¨è†å¬â€¦'; }
        else { rec.stop(); }
      }

      // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢åŠŸèƒ½
      const sidePanel = document.getElementById('side-panel');
      const mobileToggle = document.getElementById('mobile-toggle');
      
      mobileToggle.addEventListener('click', () => {
        sidePanel.classList.toggle('open');
      });
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­ä¾§è¾¹æ 
      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 920 && 
            !sidePanel.contains(e.target) && 
            e.target !== mobileToggle && 
            !mobileToggle.contains(e.target)) {
          sidePanel.classList.remove('open');
        }
      });

      document.getElementById('sendBtn').onclick = () => {
        const t = document.getElementById('text').value.trim(); if (t) sendText(t);
        document.getElementById('text').value = '';
      };
      
      // ä¸ºæ–‡æœ¬è¾“å…¥æ¡†æ·»åŠ é”®ç›˜äº‹ä»¶ï¼šå›è½¦å‘é€ï¼Œshift+enteræ¢è¡Œ
      document.getElementById('text').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          if (e.shiftKey) {
            // shift+enterï¼šæ­£å¸¸æ¢è¡Œï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
            return;
          } else {
            // å•ç‹¬å›è½¦ï¼šå‘é€æ¶ˆæ¯
            e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
            const t = document.getElementById('text').value.trim();
            if (t) {
              sendText(t);
              document.getElementById('text').value = '';
            }
          }
        }
      });
      document.getElementById('micBtn').onclick = toggleMic;
      document.getElementById('searchBtn').onclick = () => loadRoles(document.getElementById('search').value);
      document.getElementById('refreshBtn').onclick = () => loadRoles('');
      document.getElementById('themeBtn').onclick = () => {
        const body = document.body;
        const btn = document.getElementById('themeBtn');
        const next = body.dataset.theme === 'light' ? 'dark' : 'light';
        body.dataset.theme = next;
        btn.textContent = next === 'light' ? 'â˜€ï¸ æµ…è‰²' : 'ğŸŒ™ æš—è‰²';
      };
      // é»˜è®¤è¿›å…¥æµ…è‰²ä¸»é¢˜
      (function initTheme(){
        const body = document.body; const btn = document.getElementById('themeBtn');
        if (!body.dataset.theme) { body.dataset.theme = 'light'; btn.textContent = 'â˜€ï¸ æµ…è‰²'; }
      })();
      loadRoles();
    </script>
  </body>
</html>


